(function(){"use strict";function w(t,n=new Map){let e=!0;const s=t.getUint32(0,e);if(s==8558848)e=!1;else if(s!=39298)throw"not a profile";console.debug(`isLittleEndian: ${e}`);const u=1n<<63n,x=(1n<<63n)-1n,S=t.getUint32(4,e),g=S&15,f=S>>4&15;console.debug(`pointerSize: ${g}, pthreadSize: ${f}`);const E=t.getBigUint64(8,e);let h;n.forEach((i,a)=>{i==="traceBegin"&&(h=a)});const m=h?E-h:0n;console.debug(`traceBegin:${E.toString(16)}, offset: ${m.toString(16)}`);let p=1/0,b=0n;const d=new Map;for(let i=16;i<t.byteLength;){let a;f==8?(a=t.getBigUint64(i,e),i+=8):f==4&&(a=BitInt(t.getUint32(i,e)),i+=4);let o;d.has(a)?o=d.get(a):(o={frame:[],top:null},d.set(a,o));const z=t.getBigUint64(i,e);i+=8;for(let k=0n;k<z;k++){const M=t.getBigUint64(i,e);i+=8;let c;g===8?c=t.getBigUint64(i,e)-m:g===4&&(c=t.getUint32(i,e)-m),i+=g;const l=M&x;if(b<l&&(b=l),M&u){p>l&&(p=l);const r={func:c,name:n.get(c)||`<${c.toString(16)}>`,start:l,duration:null,caller:o.top,children:[]};o.top?o.top.children.push(r):o.frame.push(r),o.top=r}else{if(!o.top){console.warn(`expected enter func , got exit ${c}, stacks might be broken`);continue}const r=o.top;if(c!=r.func){console.warn(`expected exit func ${r.func}, got ${c}, stacks might be broken`);continue}r.duration=l-r.start,o.top=r.caller}}}const $=new Map;return d.forEach(({frame:i},a)=>{i.forEach(o=>B(o,p,b)),i.reduce(U,$)}),{threads:d,statistics:$}}function U(t,n){n.children.reduce(U,t);const e=n.children.reduce((s,u)=>s+u.duration,0);if(t.has(n.func)){const s=t.get(n.func);s.call+=1,s.total+=n.duration,s.self+=n.duration-e}else t.set(n.func,{name:n.name,total:n.duration,self:n.duration-e,call:1});return t}function B(t,n,e){t.duration===null&&(t.duration=e-t.start),t.start=Number(t.start-n)/1e3,t.duration=Number(t.duration)/1e3,t.children.forEach(s=>B(s,n,e))}onmessage=t=>{const{profile:n,symbolMap:e}=t.data;try{postMessage({ok:!0,data:w(n,e)})}catch(s){postMessage({ok:!1,error:s})}}})();
